<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
     :root {
       --accent-color: #05a081;
       --accent-color-light: #82d0c0;
     }
    </style>

    <meta name="theme-color" content="#05a081" />

    
    <link rel="alternate" type="application/atom+xml" title="RSS" href="https://wtfleming.github.io/atom.xml">
    

    
    
    
    
    
    
    
    
    
    <link rel="icon" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.b722df128754d46d.png" />

    <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.b722df128754d46d.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.6cc6de892c65b543.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.05bb94ecb36c25eb.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.f51b5e0bcc4516db.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.eae6a2274aff6419.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.2e54fa9ad4d11bdb.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.809ea1a0e3c3f3e0.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.7c64c06f3e2d7a67.png" />
    

    

      <meta property="og:type" content="website">

      <meta name="twitter:card" content="summary">

      

      

      
      
      <meta name="description" content="" />
      <meta name="twitter:description" content="">
      
      

      
      <meta name="twitter:title" content="Create a Clojure AWS Lambda function in Docker and deployed via AWS SAM">
      

      
      <link rel="prerender" href="&#x2F;about&#x2F;" />
      
      <link rel="prerender" href="&#x2F;blog&#x2F;" />
      


      
      <link rel="prefetch" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.9401710308142458.png" />

    <title>
      
        
          Create a Clojure AWS Lambda function in Docker and deployed via AWS SAM
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://wtfleming.github.io/main.css">
    
    
  

  

  
    <link rel="prerender"  href="https://wtfleming.github.io/tags/clojure/">
  

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "Create a Clojure AWS Lambda function in Docker and deployed via AWS SAM",
      "image": [],
      "datePublished": "2021-10-17T00:00:00+00:00",
      "dateModified": "2021-10-17T00:00:00+00:00"
    }
  </script>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "Will&#x27;s Software Journal",
          "item": "https://wtfleming.github.io/"
        },
        
        {
          
          "@type": "ListItem",
          "position": 2,
          "name": "",
          "item": "https://wtfleming.github.io/blog/"
        },
        
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Create a Clojure AWS Lambda function in Docker and deployed via AWS SAM",
          "item": "https://wtfleming.github.io/blog/clojure-aws-lambda/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
    <header>
      
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.9401710308142458.png" alt="profile picture">
        </a>
        <nav>
          
            <a href="&#x2F;about&#x2F;">About</a>
          
            <a href="&#x2F;blog&#x2F;">Blog</a>
          
        </nav>
      </header>
    
    <main>
    
  <div class="post-title">
    <h1>Create a Clojure AWS Lambda function in Docker and deployed via AWS SAM</h1>
    <small>
      October 17, 2021
      
        - 
        <span class="tags">
          
            <a href="https://wtfleming.github.io/tags/clojure/">clojure</a>
          
        </span>
      
    </small>
  </div>

  <div>
    <p>In this post I will cover using Clojure to write an <a href="https://aws.amazon.com/lambda/">AWS Lambda</a> function that will run on a schedule of once per minute. It will be deployed via the <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html">AMS SAM</a> CLI tool and use the Docker runtime. The complete code is available at <a href="https://github.com/wtfleming/clojure-aws-lambda-example">this GitHub repo</a>.</p>
<p>I'll start with a simple Lambda function that just writes a message to stdout once per minute.</p>
<p>The longer term goal is to create a function that will call the <a href="https://www.weather.gov/documentation/services-web-api">National Weather Service API</a>, and then send me a notification if there are any alerts where I live. But that will be a project for another day.</p>
<blockquote>
<p>Note that even though Lambda supports Java as a runtime, we'll be running this function in Docker.</p>
<p>While everything works great in the cloud, I ran into some compilation issues running the jar file locally with the sam invoke local command. I think the SAM CLI tool may be doing something unexpected with the java classpath, and could only get it to run without errors using the specific combination of Clojure 1.9 and Java 8. However by using Docker we can easily avoid issues like this.</p>
</blockquote>
<h2 id="project-code">Project Code</h2>
<p>I am using Leiningin for this project, so create a <code>project.clj</code> file with these contents:</p>
<pre data-lang="clojure" style="background-color:#2b303b;color:#c0c5ce;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#b48ead;">defproject </span><span style="color:#8fa1b3;">clojure-aws-lambda-example </span><span>&quot;</span><span style="color:#a3be8c;">0.1.0-SNAPSHOT</span><span>&quot;
</span><span>  </span><span style="color:#d08770;">:dependencies </span><span>[[com.amazonaws/aws-lambda-java-runtime-interface-client &quot;</span><span style="color:#a3be8c;">2.0.0</span><span>&quot;]
</span><span>                 [org.clojure/clojure &quot;</span><span style="color:#a3be8c;">1.10.3</span><span>&quot;]
</span><span>                 [org.clojure/data.json &quot;</span><span style="color:#a3be8c;">2.4.0</span><span>&quot;]]
</span><span>  </span><span style="color:#d08770;">:repl-options </span><span>{</span><span style="color:#d08770;">:init-ns</span><span> clojure-aws-lambda-example.core}
</span><span>  </span><span style="color:#d08770;">:profiles </span><span>{</span><span style="color:#d08770;">:uberjar </span><span>{</span><span style="color:#d08770;">:aot :all</span><span>}})
</span></code></pre>
<hr />
<p>Now lets write our lambda function
Create a file called <code>src/clojure_aws_lambda_example/core.clj</code> with these contents:</p>
<pre data-lang="clojure" style="background-color:#2b303b;color:#c0c5ce;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#bf616a;">ns</span><span> clojure-aws-lambda-example.core
</span><span>  (</span><span style="color:#d08770;">:require </span><span>[clojure.data.json </span><span style="color:#d08770;">:as</span><span> json]
</span><span>            [clojure.java.io </span><span style="color:#d08770;">:as</span><span> io]
</span><span>            [clojure.spec.alpha </span><span style="color:#d08770;">:as</span><span> spec])
</span><span>  (</span><span style="color:#d08770;">:gen-class
</span><span>   </span><span style="color:#d08770;">:implements </span><span>[com.amazonaws.services.lambda.runtime.RequestStreamHandler]))
</span><span>
</span><span style="color:#65737e;">;; -------------------- Specs --------------------
</span><span style="color:#65737e;">;; The json for an inbound scheduled event should look like this
</span><span style="color:#65737e;">;; {
</span><span style="color:#65737e;">;;     &quot;version&quot;: &quot;0&quot;,
</span><span style="color:#65737e;">;;     &quot;id&quot;: &quot;53dc4d37-cffa-4f76-80c9-8b7d4a4d2eaa&quot;,
</span><span style="color:#65737e;">;;     &quot;detail-type&quot;: &quot;Scheduled Event&quot;,
</span><span style="color:#65737e;">;;     &quot;source&quot;: &quot;aws.events&quot;,
</span><span style="color:#65737e;">;;     &quot;account&quot;: &quot;123456789012&quot;,
</span><span style="color:#65737e;">;;     &quot;time&quot;: &quot;2015-10-08T16:53:06Z&quot;,
</span><span style="color:#65737e;">;;     &quot;region&quot;: &quot;us-east-1&quot;,
</span><span style="color:#65737e;">;;     &quot;resources&quot;: [
</span><span style="color:#65737e;">;;         &quot;arn:aws:events:us-east-1:123456789012:rule/my-scheduled-rule&quot;
</span><span style="color:#65737e;">;;     ],
</span><span style="color:#65737e;">;;     &quot;detail&quot;: {}
</span><span style="color:#65737e;">;; }
</span><span style="color:#65737e;">;;
</span><span style="color:#65737e;">;; See https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-run-lambda-schedule.html
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::version</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::id</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::detail-type</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::source</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::account</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::time</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::region</span><span> string?)
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::resources </span><span>(</span><span style="color:#bf616a;">spec/coll-of</span><span> string?))
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::detail</span><span> map?)
</span><span>
</span><span>(</span><span style="color:#bf616a;">spec/def </span><span style="color:#d08770;">::scheduled-event
</span><span>  (</span><span style="color:#bf616a;">spec/keys
</span><span>   </span><span style="color:#d08770;">:req-un </span><span>[</span><span style="color:#d08770;">::version ::id ::detail-type ::source ::account ::time ::region ::resources ::detail</span><span>]))
</span><span>
</span><span>
</span><span style="color:#65737e;">;; -------------------- Request handling --------------------
</span><span>(</span><span style="color:#b48ead;">defn- </span><span style="color:#8fa1b3;">stream-&gt;scheduled-event
</span><span>  &quot;</span><span style="color:#a3be8c;">Transforms an input stream into a scheduled event </span><span>&quot;
</span><span>  [in]
</span><span>  (</span><span style="color:#bf616a;">json/read </span><span>(</span><span style="color:#bf616a;">io/reader</span><span> in) </span><span style="color:#d08770;">:key-fn</span><span> keyword))
</span><span>
</span><span>
</span><span>(</span><span style="color:#b48ead;">defn </span><span style="color:#8fa1b3;">-handleRequest
</span><span>  &quot;</span><span style="color:#a3be8c;">Implementation for RequestStreamHandler that handles a Lambda Function request</span><span>&quot;
</span><span>  [_ input-stream _output-stream _context]
</span><span>  (</span><span style="color:#bf616a;">println </span><span>&quot;</span><span style="color:#a3be8c;">-handleRequest called with event:</span><span>&quot; (</span><span style="color:#bf616a;">stream-&gt;scheduled-event</span><span> input-stream)))
</span></code></pre>
<h2 id="testing">Testing</h2>
<p>Lets create a simple unit test. Create a file named <code>test/eventbridge-scheduled-event.json</code> with these contents.</p>
<pre data-lang="json" style="background-color:#2b303b;color:#c0c5ce;" class="language-json "><code class="language-json" data-lang="json"><span>{
</span><span>    &quot;</span><span style="color:#a3be8c;">version</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">0</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">id</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">53dc4d37-cffa-4f76-80c9-8b7d4a4d2eaa</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">detail-type</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">Scheduled Event</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">source</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">aws.events</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">account</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">123456789012</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">time</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">2015-10-08T16:53:06Z</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">region</span><span>&quot;: &quot;</span><span style="color:#a3be8c;">us-east-1</span><span>&quot;,
</span><span>    &quot;</span><span style="color:#a3be8c;">resources</span><span>&quot;: [
</span><span>        &quot;</span><span style="color:#a3be8c;">arn:aws:events:us-east-1:123456789012:rule/my-scheduled-rule</span><span>&quot;
</span><span>    ],
</span><span>    &quot;</span><span style="color:#a3be8c;">detail</span><span>&quot;: {}
</span><span>}
</span></code></pre>
<p>And a file named <code>test/clojure_aws_lambda_example/core_test.clj</code> with these contents</p>
<pre data-lang="clojure" style="background-color:#2b303b;color:#c0c5ce;" class="language-clojure "><code class="language-clojure" data-lang="clojure"><span>(</span><span style="color:#bf616a;">ns</span><span> clojure-aws-lambda-example.core-test
</span><span>  (</span><span style="color:#d08770;">:require </span><span>[clojure.test </span><span style="color:#d08770;">:refer </span><span>[deftest is]])
</span><span>  (</span><span style="color:#d08770;">:require </span><span>[clojure-aws-lambda-example.core </span><span style="color:#d08770;">:as</span><span> lambda-example]
</span><span>            [clojure.java.io </span><span style="color:#d08770;">:as</span><span> io]
</span><span>            [clojure.spec.alpha </span><span style="color:#d08770;">:as</span><span> spec]))
</span><span>
</span><span>(</span><span style="color:#b48ead;">deftest </span><span style="color:#8fa1b3;">test-stream-&gt;scheduled-event
</span><span>  (</span><span style="color:#bf616a;">let </span><span>[stream (</span><span style="color:#bf616a;">io/input-stream </span><span>&quot;</span><span style="color:#a3be8c;">./test/eventbridge-scheduled-event.json</span><span>&quot;)
</span><span>        event (</span><span style="color:#bf616a;">lambda-example/stream-&gt;scheduled-event</span><span> stream)]
</span><span>    (</span><span style="color:#bf616a;">is </span><span>(</span><span style="color:#bf616a;">spec/valid? </span><span style="color:#d08770;">::lambda-example/scheduled-event</span><span> event))))
</span></code></pre>
<p>In the test we:</p>
<ul>
<li>Load a sample event from disk.</li>
<li>Pass it to the <code>stream-&gt;scheduled-event</code> function.</li>
<li>Use clojure.spec to validate that the return value looks correct.</li>
</ul>
<p>Note that rather than relying on a single json event, there is a much more we could test using spec's generative testing features, but I will leave that as an exercise for the reader.</p>
<hr />
<h2 id="dockerfile">Dockerfile</h2>
<p>We will also need a Dockerfile. We will use a <code>clojure:openjdk-11-slim-buster</code> image to build the Java jar, and then run the function inside a <code>eclipse-temurin:11-focal</code> container. By using a separate image to build our app, we can use a final image that doesn't have to ship Clojure build tools like lein with it.</p>
<p>Create a file named <code>Dockerfile</code></p>
<pre data-lang="Dockerfile" style="background-color:#2b303b;color:#c0c5ce;" class="language-Dockerfile "><code class="language-Dockerfile" data-lang="Dockerfile"><span style="color:#65737e;"># Docker container used to build the Clojure app
</span><span style="color:#b48ead;">FROM</span><span> clojure:openjdk-11-slim-buster </span><span style="color:#b48ead;">as </span><span style="color:#bf616a;">builder
</span><span>
</span><span style="color:#b48ead;">WORKDIR </span><span>/usr/src/app
</span><span>
</span><span style="color:#b48ead;">COPY</span><span> project.clj /usr/src/app/project.clj
</span><span>
</span><span style="color:#65737e;"># Cache deps so they aren&#39;t fetched every time a .clj file changes
</span><span style="color:#b48ead;">RUN </span><span>lein deps
</span><span>
</span><span style="color:#b48ead;">COPY</span><span> src/ /usr/src/app/src
</span><span>
</span><span style="color:#b48ead;">RUN </span><span>lein uberjar
</span><span>
</span><span>
</span><span style="color:#65737e;"># Build the docker container we will use in the lambda
</span><span style="color:#b48ead;">FROM</span><span> eclipse-temurin:11-focal
</span><span>
</span><span style="color:#b48ead;">RUN </span><span>mkdir /opt/app
</span><span>
</span><span style="color:#b48ead;">COPY</span><span> --from=</span><span style="color:#bf616a;">builder</span><span> /usr/src/app/target/clojure-aws-lambda-example-0.1.0-SNAPSHOT-standalone.jar /opt/app/app.jar
</span><span>
</span><span>ENTRYPOINT [ &quot;</span><span style="color:#a3be8c;">java</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">-cp</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">/opt/app/app.jar</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">com.amazonaws.services.lambda.runtime.api.client.AWSLambda</span><span>&quot; ]
</span><span>
</span><span>CMD [&quot;</span><span style="color:#a3be8c;">clojure_aws_lambda_example.core::handleRequest</span><span>&quot;]
</span></code></pre>
<hr />
<h2 id="sam-configuration">SAM Configuration</h2>
<p>Finally we will need a SAM template that will have all the information the SAM CLI tool needs to generate a CloudFormation template. We want to create a Lambda function and a CloudWatch event that fires every minute to trigger a run of the function.</p>
<p>Create a file <code>template.yaml</code> that looks like:</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">AWSTemplateFormatVersion</span><span>: &#39;</span><span style="color:#a3be8c;">2010-09-09</span><span>&#39;
</span><span style="color:#bf616a;">Transform</span><span>: </span><span style="color:#a3be8c;">AWS::Serverless-2016-10-31
</span><span style="color:#bf616a;">Description</span><span>: </span><span style="color:#b48ead;">&gt;
</span><span style="color:#a3be8c;">  clojure-aws-lambda-example
</span><span style="color:#a3be8c;">
</span><span style="color:#a3be8c;">  Sample SAM Template for clojure-aws-lambda-example
</span><span style="color:#a3be8c;">
</span><span style="color:#65737e;"># More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
</span><span style="color:#bf616a;">Globals</span><span>:
</span><span>  </span><span style="color:#bf616a;">Function</span><span>:
</span><span>    </span><span style="color:#bf616a;">Timeout</span><span>: </span><span style="color:#d08770;">20
</span><span>
</span><span style="color:#bf616a;">Resources</span><span>:
</span><span>  </span><span style="color:#bf616a;">ClojureAwsLambdaExampleFunction</span><span>:
</span><span>    </span><span style="color:#65737e;"># More info about Function Resource: https://github.com/awslabs/serverless-application-model/blob/master/versions/2016-10-31.md#awsserverlessfunction
</span><span>    </span><span style="color:#bf616a;">Type</span><span>: </span><span style="color:#a3be8c;">AWS::Serverless::Function
</span><span>    </span><span style="color:#bf616a;">Properties</span><span>:
</span><span>      </span><span style="color:#bf616a;">PackageType</span><span>: </span><span style="color:#a3be8c;">Image
</span><span>      </span><span style="color:#bf616a;">MemorySize</span><span>: </span><span style="color:#d08770;">256
</span><span>      </span><span style="color:#bf616a;">Architectures</span><span>:
</span><span>        - </span><span style="color:#a3be8c;">x86_64
</span><span>      </span><span style="color:#bf616a;">Events</span><span>:
</span><span>        </span><span style="color:#65737e;"># We want the lambda to run every minute
</span><span>        </span><span style="color:#65737e;"># See https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-schedule.html
</span><span>        </span><span style="color:#bf616a;">MyScheduledEvent</span><span>:
</span><span>          </span><span style="color:#bf616a;">Type</span><span>: </span><span style="color:#a3be8c;">Schedule
</span><span>          </span><span style="color:#bf616a;">Properties</span><span>:
</span><span>            </span><span style="color:#bf616a;">Schedule</span><span>: </span><span style="color:#a3be8c;">rate(1 minute)
</span><span>            </span><span style="color:#bf616a;">Name</span><span>: </span><span style="color:#a3be8c;">MyScheduledEvent
</span><span>            </span><span style="color:#bf616a;">Description</span><span>: </span><span style="color:#a3be8c;">Event that triggers the lambda every minute
</span><span>            </span><span style="color:#bf616a;">Enabled</span><span>: </span><span style="color:#d08770;">true
</span><span>    </span><span style="color:#bf616a;">Metadata</span><span>:
</span><span>      </span><span style="color:#bf616a;">DockerTag</span><span>: </span><span style="color:#a3be8c;">clojure-aws-lambda-example-v1
</span><span>      </span><span style="color:#bf616a;">DockerContext</span><span>: </span><span style="color:#a3be8c;">./
</span><span>      </span><span style="color:#bf616a;">Dockerfile</span><span>: </span><span style="color:#a3be8c;">Dockerfile
</span><span>
</span><span style="color:#bf616a;">Outputs</span><span>:
</span><span>  </span><span style="color:#bf616a;">ClojureAwsLambdaExampleFunction</span><span>:
</span><span>    </span><span style="color:#bf616a;">Description</span><span>: &quot;</span><span style="color:#a3be8c;">Hello World Lambda Function ARN</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">Value</span><span>: </span><span style="color:#b48ead;">!GetAtt </span><span style="color:#a3be8c;">ClojureAwsLambdaExampleFunction.Arn
</span><span>  </span><span style="color:#bf616a;">ClojureAwsLambdaExampleFunctionIamRole</span><span>:
</span><span>    </span><span style="color:#bf616a;">Description</span><span>: &quot;</span><span style="color:#a3be8c;">Implicit IAM Role created for Hello World function</span><span>&quot;
</span><span>    </span><span style="color:#bf616a;">Value</span><span>: </span><span style="color:#b48ead;">!GetAtt </span><span style="color:#a3be8c;">ClojureAwsLambdaExampleFunctionRole.Arn
</span></code></pre>
<h2 id="run-the-app-locally">Run the app locally</h2>
<p>Prior to deploying to the cloud we'll want to run and test on our local machine.</p>
<p>Ensure you have installed the <a href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html">AWS SAM CLI</a> installed, and then build the app.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> sam build
</span></code></pre>
<p>Run it with</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> sam local invoke</span><span style="color:#bf616a;"> --event</span><span> test/eventbridge-scheduled-event.json
</span></code></pre>
<p>You should see output similar to</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>Invoking Container created from clojureawslambdaexamplefunction:clojure-aws-lambda-example-v1
</span><span>Building image.................
</span><span>Skip pulling image and use local one: clojureawslambdaexamplefunction:rapid-1.33.0-x86_64.
</span><span>
</span><span>START RequestId: 7dfdf5e7-7580-466b-b3da-c24935837cf0 Version: $LATEST
</span><span>-handleRequest called with event:  {:detail-type Scheduled Event, :time 2015-10-08T16:53:06Z, :source aws.events, :account 123456789012, :region us-east-1, :id 53dc4d37-cffa-4f76-80c9-8b7d4a4d2eaa, :version 0, :resources [arn:aws:events:us-east-1:123456789012:rule/my-scheduled-rule], :detail {}}
</span><span>END RequestId: 7dfdf5e7-7580-466b-b3da-c24935837cf0
</span><span>REPORT RequestId: 7dfdf5e7-7580-466b-b3da-c24935837cf0  Init Duration: 0.26 ms  Duration: 795.48 ms     Billed Duration: 796 ms Memory Size: 256 MB  Max Memory Used: 256 MB
</span></code></pre>
<h2 id="deploy-to-the-cloud">Deploy to the Cloud</h2>
<p>The first time you deploy run this command to generate a local <code>samconfig.toml</code> file, an S3 bucket, and an ECR repository. When prompted for configuration info you can use the defaults the tool suggests</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> sam deploy</span><span style="color:#bf616a;"> --guided
</span></code></pre>
<p>For future deploys you can just run</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> sam deploy
</span></code></pre>
<p>Once the deploy has finished we can check that it is running by tailing the CloudWatch logs.</p>
<blockquote>
<p>Use the stack-name you choose when you ran sam deploy --guided</p>
</blockquote>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ sam logs -n ClojureAwsLambdaExampleFunction --stack-name sam-app --tail
</span></code></pre>
<p>After a few minutes of running you should see output similar to</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:00:14.729000 START RequestId: cc9f8cfd-04bf-44af-9b88-8d0349adf74e Version
</span><span>: $LATEST
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:00:14.734000 -handleRequest called! with event:  {:detail-type Scheduled Event, :time 2015-10-08T16:53:06Z, :source aws.events, :account 123456789012, :region us-east-1, :id 53dc4d37-cffa-4f76-80c9-8b7d4a4d2eaa, :version 0, :resources [arn:aws:events:us-east-1:123456789012:rule/my-scheduled-rule], :detail {}}
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:00:14.736000 END RequestId: cc9f8cfd-04bf-44af-9b88-8d0349adf74e
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:00:14.736000 REPORT RequestId: cc9f8cfd-04bf-44af-9b88-8d0349adf74e  Durat
</span><span>ion: 6.05 ms    Billed Duration: 2637 ms        Memory Size: 256 MB     Max Memory Used: 101 MB Init Duration: 2630.22 ms
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:01:15.451000 START RequestId: 4dfa088e-8328-411e-bf34-e70fe0f74691 Version
</span><span>: $LATEST
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:01:15.457000 -handleRequest called! with event:  {:detail-type Scheduled Event, :time 2015-10-08T16:53:06Z, :source aws.events, :account 123456789012, :region us-east-1, :id 53dc4d37-cffa-4f76-80c9-8b7d4a4d2eaa, :version 0, :resources [arn:aws:events:us-east-1:123456789012:rule/my-scheduled-rule], :detail {}}
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:01:15.475000 END RequestId: 4dfa088e-8328-411e-bf34-e70fe0f74691
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:01:15.475000 REPORT RequestId: 4dfa088e-8328-411e-bf34-e70fe0f74691  Durat
</span><span>ion: 18.81 ms   Billed Duration: 19 ms  Memory Size: 256 MB     Max Memory Used: 102 MB
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:02:11.605000 START RequestId: 13ae2a9c-3d0d-40eb-8427-1e7807bff399 Version
</span><span>: $LATEST
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:02:11.609000 -handleRequest called! with event:  {:detail-type Scheduled Event, :time 2015-10-08T16:53:06Z, :source aws.events, :account 123456789012, :region us-east-1, :id 53dc4d37-cffa-4f76-80c9-8b7d4a4d2eaa, :version 0, :resources [arn:aws:events:us-east-1:123456789012:rule/my-scheduled-rule], :detail {}}
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:02:11.609000 END RequestId: 13ae2a9c-3d0d-40eb-8427-1e7807bff399
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:02:11.609000 REPORT RequestId: 13ae2a9c-3d0d-40eb-8427-1e7807bff399  Durat
</span><span>ion: 1.06 ms    Billed Duration: 2 ms   Memory Size: 256 MB     Max Memory Used: 102 MB
</span><span>2021/10/17/[$LATEST]e4f5879df90c4d2f90bf036dfc1773c7 2021-10-17T16:03:11.363000 START RequestId: 76b568e8-8fa2-446f-803e-b9252db1b9a7 Version
</span><span>: $LATEST
</span></code></pre>
<h2 id="clean-up">Clean up</h2>
<p>When you are finished, you can delete the  resources associated with the stack</p>
<blockquote>
<p>Use the stack-name you choose when you ran sam deploy --guided</p>
</blockquote>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ sam delete --stack-name sam-app
</span></code></pre>

  </div>

  <hr class="footer-rule" />

  

  <div class="related-container">

    

    

  </div>


    </main>
  </body>
</html>
