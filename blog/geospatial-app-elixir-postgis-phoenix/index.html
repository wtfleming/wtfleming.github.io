<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, viewport-fit=cover"
    />

    <style>
     :root {
       --accent-color: #05a081;
       --accent-color-light: #82d0c0;
     }
    </style>

    <meta name="theme-color" content="#05a081" />

    
    <link rel="alternate" type="application/atom+xml" title="RSS" href="https://wtfleming.github.io/atom.xml">
    

    
    
    
    
    
    
    
    
    
    <link rel="icon" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.b722df128754d46d.png" />

    <link rel="apple-touch-icon" sizes="48x48" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.b722df128754d46d.png" />
    <link rel="apple-touch-icon" sizes="72x72" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.6cc6de892c65b543.png" />
    <link rel="apple-touch-icon" sizes="96x96" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.05bb94ecb36c25eb.png" />
    <link rel="apple-touch-icon" sizes="144x144" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.f51b5e0bcc4516db.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.eae6a2274aff6419.png" />
    <link rel="apple-touch-icon" sizes="256x256" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.2e54fa9ad4d11bdb.png" />
    <link rel="apple-touch-icon" sizes="384x384" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.809ea1a0e3c3f3e0.png" />
    <link rel="apple-touch-icon" sizes="512x512" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.7c64c06f3e2d7a67.png" />
    

    

      <meta property="og:type" content="website">

      <meta name="twitter:card" content="summary">

      

      

      
      
      <meta name="description" content="" />
      <meta name="twitter:description" content="">
      
      

      
      <meta name="twitter:title" content="Exploring Geospatial data in Elixir with Phoenix, D3, and PostGIS">
      

      
      <link rel="prerender" href="&#x2F;about&#x2F;" />
      
      <link rel="prerender" href="&#x2F;blog&#x2F;" />
      


      
      <link rel="prefetch" href="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.9401710308142458.png" />

    <title>
      
        
          Exploring Geospatial data in Elixir with Phoenix, D3, and PostGIS
        
      
    </title>

    
    
      <link rel="stylesheet" href="https://wtfleming.github.io/main.css">
    
    
  

  

  
    <link rel="prerender"  href="https://wtfleming.github.io/tags/erlang/">
  
    <link rel="prerender"  href="https://wtfleming.github.io/tags/elixir/">
  
    <link rel="prerender"  href="https://wtfleming.github.io/tags/postgis/">
  

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "NewsArticle",
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://google.com/article"
      },
      "headline": "Exploring Geospatial data in Elixir with Phoenix, D3, and PostGIS",
      "image": [],
      "datePublished": "2016-01-28T00:00:00+00:00",
      "dateModified": "2016-01-28T00:00:00+00:00"
    }
  </script>

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        

        
        {
          
          "@type": "ListItem",
          "position": 1,
          "name": "Will&#x27;s Software Journal",
          "item": "https://wtfleming.github.io/"
        },
        
        {
          
          "@type": "ListItem",
          "position": 2,
          "name": "",
          "item": "https://wtfleming.github.io/blog/"
        },
        
        {
          "@type": "ListItem",
          "position": 3,
          "name": "Exploring Geospatial data in Elixir with Phoenix, D3, and PostGIS",
          "item": "https://wtfleming.github.io/blog/geospatial-app-elixir-postgis-phoenix/"
        }
      ]
    }
  </script>

  </head>
  <body>
    
    <header>
      
        <a class="profile-icon" href="/">
          <img src="https:&#x2F;&#x2F;wtfleming.github.io&#x2F;processed_images&#x2F;icon.9401710308142458.png" alt="profile picture">
        </a>
        <nav>
          
            <a href="&#x2F;about&#x2F;">About</a>
          
            <a href="&#x2F;blog&#x2F;">Blog</a>
          
        </nav>
      </header>
    
    <main>
    
  <div class="post-title">
    <h1>Exploring Geospatial data in Elixir with Phoenix, D3, and PostGIS</h1>
    <small>
      January 28, 2016
      
        - 
        <span class="tags">
          
            <a href="https://wtfleming.github.io/tags/erlang/">erlang</a>
          
            <a href="https://wtfleming.github.io/tags/elixir/">elixir</a>
          
            <a href="https://wtfleming.github.io/tags/postgis/">postgis</a>
          
        </span>
      
    </small>
  </div>

  <div>
    <p>I noticed that Kaggle has started hosting some publicly available datasets. One of which is <a href="https://www.kaggle.com/kaggle/climate-data-from-ocean-ships">Ocean Ship Logbooks (1750-1850)</a>. I thought it would be interesting to visualize Captain Cook's travels on the <a href="https://en.wikipedia.org/wiki/HMS_Endeavour">HMS Endeavour</a> using the <a href="http://www.phoenixframework.org/">Phoenix Web Framework</a>, the <a href="http://d3js.org/">D3</a> JavaScript library, and <a href="http://postgis.net/">PostGIS</a>.</p>
<p>Source code is available at <a href="https://github.com/wtfleming/phoenix-postgis-example">this GitHub repo</a>.</p>
<h2 id="captain-cook-s-journeys-on-the-endeavor">Captain Cook's Journeys on the Endeavor</h2>
<div id="d3_map"></div> 
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script>
  var shipData;
  var width = 500;
  var height = 500;
  var projection = d3.geo.mercator()
    .scale(80)
    .translate([width / 2, height / 2]);

  var mapLoaded = false;

  var svg = d3.select("#d3_map")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  
  d3.json("/js/phoenix-captain-cook/world.geojson", createMap);

  function createMap(countries) {
    var geoPath = d3.geo.path().projection(projection);
    d3.select("svg").selectAll("path").data(countries.features)
      .enter()
      .append("path")
      .attr("d", geoPath)
      .attr("class", "countries");
    mapLoaded = true;
  };

  function makeRequest(url) {
    httpRequest = new XMLHttpRequest();
    if (!httpRequest) {
      console.log('Cannot create an XMLHTTP instance');
      return false;
    }
    httpRequest.onreadystatechange = jsonContents;
    httpRequest.open('GET', url);
    httpRequest.send();
  }

  function jsonContents() {
    if (httpRequest.readyState === XMLHttpRequest.DONE) {
      if (httpRequest.status === 200) {
        var response = JSON.parse(httpRequest.responseText);
        shipData = response.ship_data;
        drawCircle(shipData.slice(0));
      } else {
        console.log('There was a problem with the request.');
      }
    }
  }

  
  function drawCircle(shipDataCopy) {
    if (mapLoaded == false) {
      setTimeout(function() { drawCircle(shipData.slice(0))}, 50);
      return;
    }

    // if no data, erase the circles from the map and start over
    if (shipDataCopy.length == 0) {
      svg.selectAll("circle").remove();
      setTimeout(function() { drawCircle(shipData.slice(0))}, 50);
      return;
    }

    shipDatum = shipDataCopy.shift();

    d3.select("svg")
      .append("circle")
      .style("fill", "red")
      .attr("r", 2)
      .attr("cx", function(d) {return projection([shipDatum.lon,shipDatum.lat])[0]})
      .attr("cy", function(d) {return projection([shipDatum.lon,shipDatum.lat])[1]});

    setTimeout(function() { drawCircle(shipDataCopy) }, 50);
 }

makeRequest("/js/phoenix-captain-cook/ship_data.json");

</script>
<h2 id="docker">Docker</h2>
<p>For simplicity in this example we'll be using the <a href="https://hub.docker.com/r/mdillon/postgis/">mdillon/postgis</a> Docker image. If you already have PostGIS installed or do not want to use Docker feel free to skip this section.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># Create a persistent data volume
</span><span style="color:#bf616a;">$</span><span> sudo docker create</span><span style="color:#bf616a;"> -v</span><span> /var/lib/postgresql/data \
</span><span style="color:#bf616a;">    --name</span><span> postgres-ocean-ships-data busybox
</span><span>
</span><span style="color:#65737e;"># Create the postgis container
</span><span style="color:#bf616a;">$</span><span> sudo docker run</span><span style="color:#bf616a;"> --name</span><span> postgres-ocean-ships</span><span style="color:#bf616a;"> -p</span><span> 5432:5432 \
</span><span style="color:#bf616a;">    -e</span><span> POSTGRES_PASSWORD=postgres</span><span style="color:#bf616a;"> -d --volumes-from</span><span> postgres-ocean-ships-data \
</span><span>    mdillon/postgis:9.4
</span></code></pre>
<p>You can double check everything is working by connecting to Postgres. When prompted, the password will be "postgres", but you should consider using a much better one.</p>
<p>If you have psql installed locally you can do it like so:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> psql</span><span style="color:#bf616a;"> -h</span><span> localhost</span><span style="color:#bf616a;"> -p</span><span> 5432</span><span style="color:#bf616a;"> -U</span><span> postgres
</span></code></pre>
<p>Otherwise you can also use the one in the container and connect with these commands:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> sudo docker exec</span><span style="color:#bf616a;"> -i -t</span><span> postgres-ocean-ships bash
</span><span style="color:#bf616a;">root@10499abd059e:/#</span><span> psql</span><span style="color:#bf616a;"> -h</span><span> localhost</span><span style="color:#bf616a;"> -p</span><span> 5432</span><span style="color:#bf616a;"> -U</span><span> postgres
</span></code></pre>
<p>Now that the containers are set up, in the future you can start and stop the PostGIS container like this:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> sudo docker start postgres-ocean-ships
</span><span style="color:#bf616a;">$</span><span> sudo docker stop postgres-ocean-ships
</span></code></pre>
<h2 id="phoenix">Phoenix</h2>
<p>Create the Phoenix app:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> mix phoenix.new ocean_ship_logbooks
</span><span style="color:#bf616a;">$</span><span> cd ocean_ship_logbooks/
</span><span style="color:#bf616a;">$</span><span> mix ecto.create
</span></code></pre>
<p>Add these Elixir <a href="https://github.com/beatrichartz/csv">CSV</a> and <a href="https://github.com/bryanjos/geo">Geo</a> libraries to your mix.exs dependencies.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>{:csv, &quot;~&gt; 1.2.3&quot;}
</span><span>{:geo, &quot;~&gt; 1.0&quot;}
</span></code></pre>
<p>Fetch them</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> mix deps.get
</span></code></pre>
<p>We are going to be using be using the CSV library to parse the data, and the Geo library to work with PostGIS (via <a href="https://github.com/elixir-lang/ecto">Ecto</a>), so add to your config files (dev.exs, test.exs, and prod.secret.exs):</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span>  </span><span style="color:#d08770;">extensions: </span><span>[{</span><span style="color:#ebcb8b;">Geo</span><span>.</span><span style="color:#ebcb8b;">PostGIS</span><span>.</span><span style="color:#ebcb8b;">Extension</span><span>, </span><span style="color:#d08770;">library: </span><span style="color:#ebcb8b;">Geo</span><span>}]
</span></code></pre>
<p>For example, the database section of tour config/dev.exs should now look something like:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#65737e;"># Configure your database
</span><span>config </span><span style="color:#a3be8c;">:ocean_ship_logbooks</span><span>, </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Repo</span><span>,
</span><span>  </span><span style="color:#d08770;">adapter: </span><span style="color:#ebcb8b;">Ecto</span><span>.</span><span style="color:#ebcb8b;">Adapters</span><span>.</span><span style="color:#ebcb8b;">Postgres</span><span>,
</span><span>  </span><span style="color:#d08770;">username: </span><span>&quot;</span><span style="color:#a3be8c;">postgres</span><span>&quot;,
</span><span>  </span><span style="color:#d08770;">password: </span><span>&quot;</span><span style="color:#a3be8c;">postgres</span><span>&quot;,
</span><span>  </span><span style="color:#d08770;">database: </span><span>&quot;</span><span style="color:#a3be8c;">ocean_ship_logbooks_dev</span><span>&quot;,
</span><span>  </span><span style="color:#d08770;">hostname: </span><span>&quot;</span><span style="color:#a3be8c;">localhost</span><span>&quot;,
</span><span>  </span><span style="color:#d08770;">pool_size: 10</span><span>,
</span><span>  </span><span style="color:#d08770;">extensions: </span><span>[{</span><span style="color:#ebcb8b;">Geo</span><span>.</span><span style="color:#ebcb8b;">PostGIS</span><span>.</span><span style="color:#ebcb8b;">Extension</span><span>, </span><span style="color:#d08770;">library: </span><span style="color:#ebcb8b;">Geo</span><span>}]
</span></code></pre>
<h2 id="create-database-migrations">Create database migrations</h2>
<p>First we will want to enable the PostGIS extension in Postgres for our database. Lets generate a migration.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> mix ecto.gen.migration enable_postgis
</span><span style="color:#bf616a;">*</span><span> creating priv/repo/migrations
</span><span style="color:#bf616a;">*</span><span> creating priv/repo/migrations/20160128183445_enable_postgis.exs
</span></code></pre>
<p>Edit 20160128183445_enable_postgis.exs so that the contents are this:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#b48ead;">defmodule </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Repo</span><span>.</span><span style="color:#ebcb8b;">Migrations</span><span>.</span><span style="color:#ebcb8b;">EnablePostgis </span><span style="color:#b48ead;">do
</span><span>  </span><span style="color:#b48ead;">use </span><span style="color:#ebcb8b;">Ecto</span><span>.</span><span style="color:#ebcb8b;">Migration
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">up </span><span style="color:#b48ead;">do
</span><span>    execute &quot;</span><span style="color:#a3be8c;">CREATE EXTENSION IF NOT EXISTS postgis</span><span>&quot;
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">down </span><span style="color:#b48ead;">do
</span><span>    execute &quot;</span><span style="color:#a3be8c;">DROP EXTENSION IF EXISTS postgis</span><span>&quot;
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>Now lets create ship data table.</p>
<p>Since the ship data will be accessed via a JSON API, you normally might generate a resource with the mix <a href="http://hexdocs.pm/phoenix/Mix.Tasks.Phoenix.Gen.Json.html">phoenix.gen.json</a> task to create the model, migration, view, etc. code, but since we are using custom types from the Geo library  we'll just create them manually.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> mix ecto.gen.migration create_ship_data
</span><span style="color:#bf616a;">*</span><span> creating priv/repo/migrations
</span><span style="color:#bf616a;">*</span><span> creating priv/repo/migrations/20160128223253_create_ship_data.exs
</span></code></pre>
<p>We'll want to store the name of the ship, a timestamp, and a geometry object in the database, and we will be querying on the ship's name. Alter the file so that it has the following contents:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#b48ead;">defmodule </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Repo</span><span>.</span><span style="color:#ebcb8b;">Migrations</span><span>.</span><span style="color:#ebcb8b;">CreateShipData </span><span style="color:#b48ead;">do
</span><span>  </span><span style="color:#b48ead;">use </span><span style="color:#ebcb8b;">Ecto</span><span>.</span><span style="color:#ebcb8b;">Migration
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">change </span><span style="color:#b48ead;">do
</span><span>    create table(</span><span style="color:#a3be8c;">:ship_data</span><span>) </span><span style="color:#b48ead;">do
</span><span>      add </span><span style="color:#a3be8c;">:ship</span><span>,     </span><span style="color:#a3be8c;">:string
</span><span>      add </span><span style="color:#a3be8c;">:utc</span><span>,      </span><span style="color:#a3be8c;">:integer
</span><span>      add </span><span style="color:#a3be8c;">:geom</span><span>,     </span><span style="color:#a3be8c;">:geometry
</span><span>    </span><span style="color:#b48ead;">end
</span><span>    create index(</span><span style="color:#a3be8c;">:ship_data</span><span>, [</span><span style="color:#a3be8c;">:ship</span><span>])
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>Run the migrations:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> mix ecto.migrate
</span></code></pre>
<h2 id="shipdata-model">ShipData Model</h2>
<p>Create a file at web/models/ship_data.ex with these contents:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#b48ead;">defmodule </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">ShipData </span><span style="color:#b48ead;">do
</span><span>  </span><span style="color:#b48ead;">use </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Web</span><span>, </span><span style="color:#a3be8c;">:model
</span><span>  schema &quot;</span><span style="color:#a3be8c;">ship_data</span><span>&quot; </span><span style="color:#b48ead;">do
</span><span>    field </span><span style="color:#a3be8c;">:ship</span><span>, </span><span style="color:#a3be8c;">:string
</span><span>    field </span><span style="color:#a3be8c;">:utc</span><span>,  </span><span style="color:#a3be8c;">:integer
</span><span>    field </span><span style="color:#a3be8c;">:geom</span><span>, </span><span style="color:#ebcb8b;">Geo</span><span>.</span><span style="color:#ebcb8b;">Point
</span><span>  </span><span style="color:#b48ead;">end
</span><span style="color:#b48ead;">end
</span></code></pre>
<p>This is a pretty straightforward model. We are using the Geo library so we can use a geometry column type that is specific to PostGIS.</p>
<h2 id="shipdata-view">ShipData View</h2>
<p>Create a file web/views/ship_data_view.ex with these contents:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#b48ead;">defmodule </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">ShipDataView </span><span style="color:#b48ead;">do
</span><span>  </span><span style="color:#b48ead;">use </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Web</span><span>, </span><span style="color:#a3be8c;">:view
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">render</span><span>(&quot;</span><span style="color:#a3be8c;">show_ships.json</span><span>&quot;, %{</span><span style="color:#d08770;">ships:</span><span> ships}) </span><span style="color:#b48ead;">do
</span><span>   %{</span><span style="color:#d08770;">ship_data:</span><span> render_many(ships, </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">ShipDataView</span><span>, &quot;</span><span style="color:#a3be8c;">ship_data.json</span><span>&quot;)}
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">render</span><span>(&quot;</span><span style="color:#a3be8c;">ship_data.json</span><span>&quot;, %{</span><span style="color:#d08770;">ship_data:</span><span> ship}) </span><span style="color:#b48ead;">do
</span><span>    {lat, lon} = ship.geom.coordinates
</span><span>
</span><span>    %{</span><span style="color:#d08770;">ship:</span><span> ship.ship,
</span><span>      </span><span style="color:#d08770;">utc:</span><span> ship.utc,
</span><span>      </span><span style="color:#d08770;">lat:</span><span> lat,
</span><span>      </span><span style="color:#d08770;">lon:</span><span> lon}
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">end
</span></code></pre>
<h2 id="router">Router</h2>
<p>Look in web/router.ex for the api block. Uncomment it and change to look like this:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#65737e;"># Other scopes may use custom stacks.
</span><span>scope &quot;</span><span style="color:#a3be8c;">/api</span><span>&quot;, </span><span style="color:#ebcb8b;">OceanShipLogbooks </span><span style="color:#b48ead;">do
</span><span>  pipe_through </span><span style="color:#a3be8c;">:api
</span><span>  resources &quot;</span><span style="color:#a3be8c;">/ship_data</span><span>&quot;, </span><span style="color:#ebcb8b;">ShipDataController</span><span>, </span><span style="color:#d08770;">only: </span><span>[</span><span style="color:#a3be8c;">:index</span><span>]
</span><span style="color:#b48ead;">end
</span></code></pre>
<h2 id="ship-data-controller">Ship Data Controller</h2>
<p>Create a file web/controllers/ship_data_controller.ex with these contents:</p>
<pre data-lang="elixir" style="background-color:#2b303b;color:#c0c5ce;" class="language-elixir "><code class="language-elixir" data-lang="elixir"><span style="color:#b48ead;">defmodule </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">ShipDataController </span><span style="color:#b48ead;">do
</span><span>  </span><span style="color:#b48ead;">use </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Web</span><span>, </span><span style="color:#a3be8c;">:controller
</span><span>  </span><span style="color:#b48ead;">alias </span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">ShipData
</span><span>
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">index</span><span>(conn, _params) </span><span style="color:#b48ead;">do
</span><span style="color:#65737e;">    # For simplicity in this example we hard code against
</span><span style="color:#65737e;">    # a specific ship name.
</span><span>    query = from s in </span><span style="color:#ebcb8b;">ShipData</span><span>,
</span><span>    </span><span style="color:#d08770;">where:</span><span> s.ship == &quot;</span><span style="color:#a3be8c;">Endeavour</span><span>&quot;,
</span><span>    </span><span style="color:#d08770;">order_by: </span><span>[</span><span style="color:#d08770;">asc:</span><span> s.utc],
</span><span>    </span><span style="color:#d08770;">select:</span><span> s
</span><span>
</span><span>    ships = </span><span style="color:#ebcb8b;">Repo</span><span>.all(query)
</span><span>    render(conn, &quot;</span><span style="color:#a3be8c;">show_ships.json</span><span>&quot;, </span><span style="color:#d08770;">ships:</span><span> ships)
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>
</span><span style="color:#65737e;">  # These next two functions probably do not belong in a controller,
</span><span style="color:#65737e;">  # since they are for manually importing data, but we put them in here
</span><span style="color:#65737e;">  # for this example.
</span><span>  </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">import_from_csv</span><span>() </span><span style="color:#b48ead;">do
</span><span>    </span><span style="color:#ebcb8b;">File</span><span>.stream!(&quot;</span><span style="color:#a3be8c;">ship-data.csv</span><span>&quot;)
</span><span>    |&gt; </span><span style="color:#ebcb8b;">CSV</span><span>.decode(</span><span style="color:#d08770;">headers: true</span><span>)
</span><span>    |&gt; </span><span style="color:#ebcb8b;">Stream</span><span>.filter(</span><span style="color:#b48ead;">fn</span><span>(x) -&gt; x[&quot;</span><span style="color:#a3be8c;">Lat3</span><span>&quot;] != &quot;</span><span style="color:#a3be8c;">NA</span><span>&quot; and x[&quot;</span><span style="color:#a3be8c;">Lon3</span><span>&quot;] != &quot;</span><span style="color:#a3be8c;">NA</span><span>&quot; </span><span style="color:#b48ead;">end</span><span>)
</span><span>    |&gt; </span><span style="color:#ebcb8b;">Stream</span><span>.map(&amp;</span><span style="color:#bf616a;">build_ship</span><span>/</span><span style="color:#d08770;">1</span><span>)
</span><span>    |&gt; </span><span style="color:#ebcb8b;">Enum</span><span>.each(&amp;</span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">Repo</span><span>.insert!/</span><span style="color:#d08770;">1</span><span>)
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span>  </span><span style="color:#b48ead;">defp </span><span style="color:#8fa1b3;">build_ship</span><span>(row) </span><span style="color:#b48ead;">do
</span><span>    {lat, _} = </span><span style="color:#ebcb8b;">Float</span><span>.parse(row[&quot;</span><span style="color:#a3be8c;">Lat3</span><span>&quot;])
</span><span>    {lon, _} = </span><span style="color:#ebcb8b;">Float</span><span>.parse(row[&quot;</span><span style="color:#a3be8c;">Lon3</span><span>&quot;])
</span><span>    {utc, _} = </span><span style="color:#ebcb8b;">Integer</span><span>.parse(row[&quot;</span><span style="color:#a3be8c;">UTC</span><span>&quot;])
</span><span>    geom = %</span><span style="color:#ebcb8b;">Geo</span><span>.</span><span style="color:#ebcb8b;">Point</span><span>{ </span><span style="color:#d08770;">coordinates: </span><span>{lat, lon}, </span><span style="color:#d08770;">srid: 4326</span><span>}
</span><span>    %</span><span style="color:#ebcb8b;">OceanShipLogbooks</span><span>.</span><span style="color:#ebcb8b;">ShipData</span><span>{</span><span style="color:#d08770;">ship:</span><span> row[&quot;</span><span style="color:#a3be8c;">ShipName</span><span>&quot;], </span><span style="color:#d08770;">utc:</span><span> utc, </span><span style="color:#d08770;">geom:</span><span> geom}
</span><span>  </span><span style="color:#b48ead;">end
</span><span>
</span><span style="color:#b48ead;">end
</span></code></pre>
<h2 id="download-and-clean-the-data">Download and clean the data.</h2>
<p>Ensure you have downloaded the data the <a href="https://www.kaggle.com/kaggle/climate-data-from-ocean-ships">ship data from Kaggle</a>. Extract the file CLIWOC15.csv into the root directory of your project (this file should be about 200 megabytes in size).</p>
<p>Unfortunately the Elixir CSV parser we are using <a href="https://github.com/beatrichartz/csv/issues/13">is not RFC 4180 compliant</a> and the ship data includes fields with escaped newlines. I did not investigate other Elixir or Erlang CSV parsers, so while not ideal, until this is fixed I removed the newlines with the following python script called transform_csv.py:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#b48ead;">import </span><span>csv
</span><span>
</span><span style="color:#b48ead;">with </span><span style="color:#96b5b4;">open</span><span>(&quot;</span><span style="color:#a3be8c;">CLIWOC15.csv</span><span>&quot;, &#39;</span><span style="color:#a3be8c;">rU</span><span>&#39;) </span><span style="color:#b48ead;">as </span><span>csvIN:
</span><span>    </span><span style="color:#b48ead;">with </span><span style="color:#96b5b4;">open</span><span>(&#39;</span><span style="color:#a3be8c;">ship-data.csv</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">wb</span><span>&#39;) </span><span style="color:#b48ead;">as </span><span>csvOUT:
</span><span>        writer = csv.</span><span style="color:#bf616a;">writer</span><span>(csvOUT, </span><span style="color:#bf616a;">delimiter</span><span>=&#39;</span><span style="color:#a3be8c;">,</span><span>&#39;, </span><span style="color:#bf616a;">quoting</span><span>=csv.</span><span style="color:#bf616a;">QUOTE_ALL</span><span>)
</span><span>        </span><span style="color:#b48ead;">for </span><span>line </span><span style="color:#b48ead;">in </span><span>csv.</span><span style="color:#bf616a;">reader</span><span>(csvIN, </span><span style="color:#bf616a;">delimiter</span><span>=&#39;</span><span style="color:#a3be8c;">,</span><span>&#39;):
</span><span>            line = [x.</span><span style="color:#bf616a;">replace</span><span>(&#39;</span><span style="color:#96b5b4;">\n</span><span>&#39;, &#39;&#39;) </span><span style="color:#b48ead;">for </span><span>x </span><span style="color:#b48ead;">in </span><span>line]
</span><span>            writer.</span><span style="color:#bf616a;">writerow</span><span>(line)
</span><span>
</span></code></pre>
<p>Run the script to remove extraneous newlines:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> python transform-csv.py
</span></code></pre>
<h2 id="load-the-data-into-postgis">Load the data into PostGIS</h2>
<p>Run the app inside IEx (Interactive Elixir):</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> iex</span><span style="color:#bf616a;"> -S</span><span> mix phoenix.server
</span><span style="color:#bf616a;">iex</span><span>(1)&gt; OceanShipLogbooks.ShipDataController.import_from_csv
</span><span style="color:#65737e;"># Exit iex
</span></code></pre>
<p>Now verify the data is in PostGIS. Your session should look something like this:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> psql</span><span style="color:#bf616a;"> -h</span><span> localhost</span><span style="color:#bf616a;"> -p</span><span> 5432</span><span style="color:#bf616a;"> -U</span><span> postgres ocean_ship_logbooks_dev
</span><span>
</span><span style="color:#bf616a;">ocean_ship_logbooks_dev</span><span>=</span><span style="color:#a3be8c;"># </span><span style="color:#bf616a;">select</span><span> count(*) </span><span style="color:#bf616a;">from</span><span> ship_data;
</span><span> </span><span style="color:#bf616a;">count  
</span><span style="color:#bf616a;">--------
</span><span> </span><span style="color:#bf616a;">252917
</span><span>(</span><span style="color:#bf616a;">1</span><span> row)
</span><span>
</span><span>
</span><span style="color:#bf616a;">ocean_ship_logbooks_dev</span><span>=</span><span style="color:#a3be8c;"># </span><span style="color:#bf616a;">select </span><span>* from ship_data where ship = &#39;</span><span style="color:#a3be8c;">Endeavour</span><span>&#39; limit 4;
</span><span>  </span><span style="color:#bf616a;">id   </span><span>|   </span><span style="color:#bf616a;">ship    </span><span>|    </span><span style="color:#bf616a;">utc     </span><span>|                        </span><span style="color:#bf616a;">geom                        
</span><span style="color:#bf616a;">-------+-----------+------------+----------------------------------------------------
</span><span> </span><span style="color:#bf616a;">41085 </span><span>| </span><span style="color:#bf616a;">Endeavour </span><span>| </span><span style="color:#bf616a;">1768110915 </span><span>| </span><span style="color:#bf616a;">0101000020E610000024287E8CB97B35C03333333333D342C0
</span><span> </span><span style="color:#bf616a;">41084 </span><span>| </span><span style="color:#bf616a;">Endeavour </span><span>| </span><span style="color:#bf616a;">1768093011 </span><span>| </span><span style="color:#bf616a;">0101000020E61000006666666666E62F40423EE8D9ACAA35C0
</span><span> </span><span style="color:#bf616a;">41083 </span><span>| </span><span style="color:#bf616a;">Endeavour </span><span>| </span><span style="color:#bf616a;">1768090513 </span><span>| </span><span style="color:#bf616a;">0101000020E6100000545227A08988454000000000000024C0
</span><span> </span><span style="color:#bf616a;">41082 </span><span>| </span><span style="color:#bf616a;">Endeavour </span><span>| </span><span style="color:#bf616a;">1768090413 </span><span>| </span><span style="color:#bf616a;">0101000020E6100000AE47E17A14CE4540D7A3703D0A5724C0
</span></code></pre>
<p>You can also query the data via the phoenix app:</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> iex</span><span style="color:#bf616a;"> -S</span><span> mix phoenix.server
</span><span>
</span><span style="color:#bf616a;">iex</span><span>(1)&gt; import </span><span style="color:#bf616a;">Ecto.Query,</span><span> only: </span><span style="color:#b48ead;">[</span><span>from: 2</span><span style="color:#b48ead;">]
</span><span style="color:#bf616a;">iex</span><span>(2)&gt; query = </span><span style="color:#bf616a;">from</span><span> s in OceanShipLogbooks.ShipData,
</span><span style="color:#bf616a;">...</span><span>(2)&gt; where: </span><span style="color:#bf616a;">s.ship</span><span> == &quot;</span><span style="color:#a3be8c;">Endeavour</span><span>&quot;,
</span><span style="color:#bf616a;">...</span><span>(2)&gt; limit: </span><span style="color:#bf616a;">4,
</span><span style="color:#bf616a;">...</span><span>(2)&gt; select: </span><span style="color:#bf616a;">s
</span><span style="color:#bf616a;">iex</span><span>(3)&gt; ships = </span><span style="color:#bf616a;">OceanShipLogbooks.Repo.all</span><span>(query)
</span><span style="color:#bf616a;">[</span><span>%</span><span style="color:#bf616a;">OceanShipLogbooks.ShipData{__meta__: </span><span style="color:#65737e;">#Ecto.Schema.Metadata&lt;:loaded&gt;,
</span><span>  </span><span style="color:#bf616a;">geom: </span><span>%</span><span style="color:#bf616a;">Geo</span><span>.Point{coordinates: {-21.4833, -37.65}, srid: 4326}, id: 41085,
</span><span>  </span><span style="color:#bf616a;">ship: </span><span>&quot;</span><span style="color:#a3be8c;">Endeavour</span><span>&quot;, utc: 1768110915}</span><span style="color:#bf616a;">,
</span><span> %</span><span style="color:#bf616a;">OceanShipLogbooks.ShipData{__meta__: </span><span style="color:#65737e;">#Ecto.Schema.Metadata&lt;:loaded&gt;,
</span><span>  </span><span style="color:#bf616a;">geom: </span><span>%</span><span style="color:#bf616a;">Geo</span><span>.Point{coordinates: {15.95, -21.6667}, srid: 4326}, id: 41084,
</span><span>  </span><span style="color:#bf616a;">ship: </span><span>&quot;</span><span style="color:#a3be8c;">Endeavour</span><span>&quot;, utc: 1768093011}</span><span style="color:#bf616a;">,
</span><span> %</span><span style="color:#bf616a;">OceanShipLogbooks.ShipData{__meta__: </span><span style="color:#65737e;">#Ecto.Schema.Metadata&lt;:loaded&gt;,
</span><span>  </span><span style="color:#bf616a;">geom: </span><span>%</span><span style="color:#bf616a;">Geo</span><span>.Point{coordinates: {43.0667, -10.0}, srid: 4326}, id: 41083,
</span><span>  </span><span style="color:#bf616a;">ship: </span><span>&quot;</span><span style="color:#a3be8c;">Endeavour</span><span>&quot;, utc: 1768090513}</span><span style="color:#bf616a;">,
</span><span> %</span><span style="color:#bf616a;">OceanShipLogbooks.ShipData{__meta__: </span><span style="color:#65737e;">#Ecto.Schema.Metadata&lt;:loaded&gt;,
</span><span>  </span><span style="color:#bf616a;">geom: </span><span>%</span><span style="color:#bf616a;">Geo</span><span>.Point{coordinates: {43.61, -10.17}, srid: 4326}, id: 41082,
</span><span>  </span><span style="color:#bf616a;">ship: </span><span>&quot;</span><span style="color:#a3be8c;">Endeavour</span><span>&quot;, utc: 1768090413}</span><span style="color:#bf616a;">]
</span></code></pre>
<p>Feel free to delete the CSV files to clear up a few hundred megs of disk space.</p>
<h2 id="download-countries-geojson">Download Countries GeoJSON</h2>
<p>Get the GeoGSON data from <a href="http://emeeks.github.io/d3ia/world.geojson">this GitHub repo</a> and put the geojson file at priv/static/js/world.geojson</p>
<p>This will let us draw a map of the world in D3.</p>
<h2 id="html-and-javascript-code">HTML and Javascript code</h2>
<p>Edit web/templates/page/index.html.eex to look like this:</p>
<pre data-lang="html" style="background-color:#2b303b;color:#c0c5ce;" class="language-html "><code class="language-html" data-lang="html"><span>&lt;</span><span style="color:#bf616a;">div </span><span style="color:#d08770;">class</span><span>=&quot;</span><span style="color:#a3be8c;">jumbotron</span><span>&quot;&gt;
</span><span>  &lt;</span><span style="color:#bf616a;">h2</span><span>&gt;Captain Cook&#39;s travels&lt;/</span><span style="color:#bf616a;">h2</span><span>&gt;
</span><span>&lt;/</span><span style="color:#bf616a;">div</span><span>&gt;
</span><span>
</span><span>&lt;</span><span style="color:#bf616a;">div </span><span style="color:#8fa1b3;">id</span><span>=&quot;</span><span style="color:#a3be8c;">d3_map</span><span>&quot;&gt;&lt;/</span><span style="color:#bf616a;">div</span><span>&gt; 
</span><span>
</span><span>&lt;</span><span style="color:#bf616a;">script </span><span style="color:#d08770;">src</span><span>=&quot;</span><span style="color:#a3be8c;">//d3js.org/d3.v3.min.js</span><span>&quot; </span><span style="color:#d08770;">charset</span><span>=&quot;</span><span style="color:#a3be8c;">utf-8</span><span>&quot;&gt;&lt;/</span><span style="color:#bf616a;">script</span><span>&gt;
</span><span>
</span><span>&lt;</span><span style="color:#bf616a;">script</span><span>&gt;
</span><span>  </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">shipData</span><span>;
</span><span>  </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">width </span><span>= </span><span style="color:#d08770;">500</span><span>;
</span><span>  </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">height </span><span>= </span><span style="color:#d08770;">500</span><span>;
</span><span>  </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">projection </span><span>= </span><span style="color:#bf616a;">d3</span><span>.geo.</span><span style="color:#bf616a;">mercator</span><span>()
</span><span>    .</span><span style="color:#bf616a;">scale</span><span>(</span><span style="color:#d08770;">80</span><span>)
</span><span>    .</span><span style="color:#bf616a;">translate</span><span>([</span><span style="color:#bf616a;">width </span><span>/ </span><span style="color:#d08770;">2</span><span>, </span><span style="color:#bf616a;">height </span><span>/ </span><span style="color:#d08770;">2</span><span>]);
</span><span>
</span><span>  </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">svg </span><span>= </span><span style="color:#bf616a;">d3</span><span>.</span><span style="color:#bf616a;">select</span><span>(&quot;</span><span style="color:#a3be8c;">#d3_map</span><span>&quot;)
</span><span>    .</span><span style="color:#bf616a;">append</span><span>(&quot;</span><span style="color:#a3be8c;">svg</span><span>&quot;)
</span><span>    .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">width</span><span>&quot;, </span><span style="color:#bf616a;">width</span><span>)
</span><span>    .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">height</span><span>&quot;, </span><span style="color:#bf616a;">height</span><span>);
</span><span>  
</span><span>  </span><span style="color:#bf616a;">d3</span><span>.</span><span style="color:#bf616a;">json</span><span>(&quot;</span><span style="color:#a3be8c;">/js/world.geojson</span><span>&quot;, </span><span style="color:#bf616a;">createMap</span><span>);
</span><span>
</span><span>  </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">createMap</span><span>(countries) {
</span><span>    </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">geoPath </span><span>= </span><span style="color:#bf616a;">d3</span><span>.geo.</span><span style="color:#bf616a;">path</span><span>().</span><span style="color:#bf616a;">projection</span><span>(</span><span style="color:#bf616a;">projection</span><span>);
</span><span>    </span><span style="color:#bf616a;">d3</span><span>.</span><span style="color:#bf616a;">select</span><span>(&quot;</span><span style="color:#a3be8c;">svg</span><span>&quot;).</span><span style="color:#bf616a;">selectAll</span><span>(&quot;</span><span style="color:#a3be8c;">path</span><span>&quot;).</span><span style="color:#bf616a;">data</span><span>(</span><span style="color:#bf616a;">countries</span><span>.features)
</span><span>      .</span><span style="color:#bf616a;">enter</span><span>()
</span><span>      .</span><span style="color:#bf616a;">append</span><span>(&quot;</span><span style="color:#a3be8c;">path</span><span>&quot;)
</span><span>      .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">d</span><span>&quot;, </span><span style="color:#bf616a;">geoPath</span><span>)
</span><span>      .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">class</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">countries</span><span>&quot;);
</span><span>  };
</span><span>
</span><span>  </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">makeRequest</span><span>(url) {
</span><span>    </span><span style="color:#bf616a;">httpRequest </span><span>= new </span><span style="color:#ebcb8b;">XMLHttpRequest</span><span>();
</span><span>    </span><span style="color:#b48ead;">if </span><span>(!</span><span style="color:#bf616a;">httpRequest</span><span>) {
</span><span>      console.</span><span style="color:#96b5b4;">log</span><span>(&#39;</span><span style="color:#a3be8c;">Cannot create an XMLHTTP instance</span><span>&#39;);
</span><span>      </span><span style="color:#b48ead;">return </span><span style="color:#d08770;">false</span><span>;
</span><span>    }
</span><span>    </span><span style="color:#bf616a;">httpRequest</span><span>.onreadystatechange = </span><span style="color:#bf616a;">jsonContents</span><span>;
</span><span>    </span><span style="color:#bf616a;">httpRequest</span><span>.</span><span style="color:#bf616a;">open</span><span>(&#39;</span><span style="color:#a3be8c;">GET</span><span>&#39;, </span><span style="color:#bf616a;">url</span><span>);
</span><span>    </span><span style="color:#bf616a;">httpRequest</span><span>.</span><span style="color:#bf616a;">send</span><span>();
</span><span>  }
</span><span>
</span><span>  </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">jsonContents</span><span>() {
</span><span>    </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">httpRequest</span><span>.readyState === </span><span style="color:#ebcb8b;">XMLHttpRequest</span><span>.DONE) {
</span><span>      </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">httpRequest</span><span>.status === </span><span style="color:#d08770;">200</span><span>) {
</span><span>        </span><span style="color:#b48ead;">var </span><span style="color:#bf616a;">response </span><span>= JSON.</span><span style="color:#96b5b4;">parse</span><span>(</span><span style="color:#bf616a;">httpRequest</span><span>.responseText);
</span><span>        </span><span style="color:#bf616a;">shipData </span><span>= </span><span style="color:#bf616a;">response</span><span>.ship_data;
</span><span>        </span><span style="color:#bf616a;">drawCircle</span><span>(</span><span style="color:#bf616a;">shipData</span><span>.</span><span style="color:#bf616a;">slice</span><span>(</span><span style="color:#d08770;">0</span><span>));
</span><span>      } </span><span style="color:#b48ead;">else </span><span>{
</span><span>        console.</span><span style="color:#96b5b4;">log</span><span>(&#39;</span><span style="color:#a3be8c;">There was a problem with the request.</span><span>&#39;);
</span><span>      }
</span><span>    }
</span><span>  }
</span><span>  
</span><span>  </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">drawCircle</span><span>(shipDataCopy) {
</span><span>    </span><span style="color:#65737e;">// if no data, erase the circles from the map and start over
</span><span>    </span><span style="color:#b48ead;">if </span><span>(</span><span style="color:#bf616a;">shipDataCopy</span><span>.length == </span><span style="color:#d08770;">0</span><span>) {
</span><span>      </span><span style="color:#bf616a;">svg</span><span>.</span><span style="color:#bf616a;">selectAll</span><span>(&quot;</span><span style="color:#a3be8c;">circle</span><span>&quot;).</span><span style="color:#bf616a;">remove</span><span>();
</span><span>      </span><span style="color:#96b5b4;">setTimeout</span><span>(</span><span style="color:#b48ead;">function</span><span>() { </span><span style="color:#bf616a;">drawCircle</span><span>(</span><span style="color:#bf616a;">shipData</span><span>.</span><span style="color:#bf616a;">slice</span><span>(</span><span style="color:#d08770;">0</span><span>))}, </span><span style="color:#d08770;">50</span><span>);
</span><span>      </span><span style="color:#b48ead;">return</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#bf616a;">shipDatum </span><span>= </span><span style="color:#bf616a;">shipDataCopy</span><span>.</span><span style="color:#bf616a;">shift</span><span>();
</span><span>
</span><span>    </span><span style="color:#bf616a;">d3</span><span>.</span><span style="color:#bf616a;">select</span><span>(&quot;</span><span style="color:#a3be8c;">svg</span><span>&quot;)
</span><span>      .</span><span style="color:#bf616a;">append</span><span>(&quot;</span><span style="color:#a3be8c;">circle</span><span>&quot;)
</span><span>      .</span><span style="color:#bf616a;">style</span><span>(&quot;</span><span style="color:#a3be8c;">fill</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">red</span><span>&quot;)
</span><span>      .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">r</span><span>&quot;, </span><span style="color:#d08770;">2</span><span>)
</span><span>      .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">cx</span><span>&quot;, </span><span style="color:#b48ead;">function</span><span>(d) {</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">projection</span><span>([</span><span style="color:#bf616a;">shipDatum</span><span>.lon,</span><span style="color:#bf616a;">shipDatum</span><span>.lat])[</span><span style="color:#d08770;">0</span><span>]})
</span><span>      .</span><span style="color:#bf616a;">attr</span><span>(&quot;</span><span style="color:#a3be8c;">cy</span><span>&quot;, </span><span style="color:#b48ead;">function</span><span>(d) {</span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">projection</span><span>([</span><span style="color:#bf616a;">shipDatum</span><span>.lon,</span><span style="color:#bf616a;">shipDatum</span><span>.lat])[</span><span style="color:#d08770;">1</span><span>]});
</span><span>
</span><span>    </span><span style="color:#96b5b4;">setTimeout</span><span>(</span><span style="color:#b48ead;">function</span><span>() { </span><span style="color:#bf616a;">drawCircle</span><span>(</span><span style="color:#bf616a;">shipDataCopy</span><span>) }, </span><span style="color:#d08770;">50</span><span>);
</span><span> }
</span><span>
</span><span style="color:#bf616a;">makeRequest</span><span>(&quot;</span><span style="color:#a3be8c;">/api/ship_data</span><span>&quot;);
</span><span>
</span><span>&lt;/</span><span style="color:#bf616a;">script</span><span>&gt;
</span></code></pre>
<p>Now start the server</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">$</span><span> mix phoenix.server
</span></code></pre>
<p>Open a web browser to <a href="http://localhost:4000">http://localhost:4000</a> to see an animation like at the top of this post and a page that should look something like this:</p>
<p><img src="/images/phoenix-postgis-captain-cook/cooks-travels.jpg" alt="Cook&#39;s Travel" /></p>

  </div>

  <hr class="footer-rule" />

  

  <div class="related-container">

    

    

  </div>


    </main>
  </body>
</html>
